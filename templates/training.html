{% extends "base.html" %}

{% block title %}Model Training - Fraud Detection System{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Training Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-watson alert-custom">
                <h4><i class="fas fa-brain"></i> Model Training & Selection</h4>
                <p class="mb-0">Use existing Watson X models or train new ones</p>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Model Selection -->
        <div class="col-lg-8 mb-4">
            <!-- Model Source Selection -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-robot"></i> Select Model Source</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <div class="card h-100 border-primary" id="watsonCard" style="cursor: pointer;" onclick="selectModelSource('watson')">
                                <div class="card-body text-center">
                                    <i class="fas fa-cloud fa-3x text-primary mb-3"></i>
                                    <h5>Use Watson X Model</h5>
                                    <p class="text-muted small">Pre-trained models from Watson X</p>
                                    {% if watson_models %}
                                    <span class="badge bg-success">{{ watson_models|length }} models available</span>
                                    {% else %}
                                    <span class="badge bg-warning">No models found</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="card h-100" id="newCard" style="cursor: pointer;" onclick="selectModelSource('new')">
                                <div class="card-body text-center">
                                    <i class="fas fa-graduation-cap fa-3x text-secondary mb-3"></i>
                                    <h5>Train New Model</h5>
                                    <p class="text-muted small">Train from preprocessed data</p>
                                    <span class="badge bg-info">Feature coming soon</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Watson Model Selection -->
            <div id="watsonModelSelection" class="card border-0 shadow-sm mb-4" style="display: none;">
                <div class="card-header" style="background: linear-gradient(135deg, #0f62fe 0%, #0043ce 100%); color: white;">
                    <h5 class="mb-0"><i class="fas fa-cloud"></i> Available Watson X Models</h5>
                </div>
                <div class="card-body">
                    {% if watson_models %}
                    <div class="mb-3">
                        <label class="form-label">Select Watson X Model:</label>
                        <select class="form-select form-select-lg" id="watsonModelSelect">
                            <option value="">-- Select a model --</option>
                            {% for model in watson_models %}
                            <option value="{{ model.name }}">
                                {{ model.name }} ({{ model.type }})
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> 
                        <strong>Model Performance:</strong><br>
                        • ROC-AUC: 0.9367<br>
                        • Precision: 73.7%<br>
                        • Recall: 35.0%<br>
                        • False Positives: 10 (optimized threshold)
                    </div>
                    {% else %}
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i> 
                        No Watson X models found. Please check your models/models-watsonx folder.
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- New Model Training -->
            <div id="newModelTraining" class="card border-0 shadow-sm mb-4" style="display: none;">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0"><i class="fas fa-graduation-cap"></i> Train New Model</h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> 
                        Advanced model training feature coming soon!<br>
                        For now, you can use the pre-trained Watson X models.
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Algorithm</label>
                            <select class="form-select" disabled>
                                <option>Logistic Regression</option>
                                <option>XGBoost</option>
                                <option>LightGBM</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Validation Split</label>
                            <input type="range" class="form-range" value="20" disabled>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Run Training Button -->
            <button class="btn btn-primary-custom btn-custom btn-lg w-100 mb-4" id="runTrainingBtn" onclick="runTraining()">
                <i class="fas fa-rocket"></i> Load/Train Model
            </button>

            <!-- Training Results -->
            <div id="trainingResults" class="card border-0 shadow-sm" style="display: none;">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-check-circle"></i> Model Ready!</h5>
                </div>
                <div class="card-body">
                    <div id="modelStats" class="mb-3">
                        <!-- Stats will be inserted here -->
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <button class="btn btn-success-custom btn-custom w-100" onclick="proceedToPrediction()">
                                <i class="fas fa-magic"></i> Make Predictions
                            </button>
                        </div>
                        <div class="col-md-6">
                            <button class="btn btn-outline-primary btn-custom w-100" onclick="viewModelDetails()">
                                <i class="fas fa-chart-bar"></i> View Details
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Model Information Sidebar -->
        <div class="col-lg-4 mb-4">
            <!-- Dataset Status -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-database"></i> Dataset Status</h5>
                </div>
                <div class="card-body">
                    {% if processed_status.success %}
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle"></i> Dataset ready
                    </div>
                    <p><strong>File:</strong> {{ processed_status.processed_file }}</p>
                    {% if processed_status.stats %}
                    <p><strong>Features:</strong> {{ processed_status.stats.features }}</p>
                    <p><strong>Rows:</strong> {{ processed_status.stats.rows }}</p>
                    {% endif %}
                    {% else %}
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i> No dataset loaded
                    </div>
                    <a href="/preprocessing" class="btn btn-outline-primary btn-sm w-100">
                        Go to Preprocessing
                    </a>
                    {% endif %}
                </div>
            </div>

            <!-- Model Comparison -->
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0"><i class="fas fa-chart-bar"></i> Model Comparison</h5>
                </div>
                <div class="card-body">
                    <div class="model-comparison">
                        <div class="mb-3">
                            <h6>Logistic Regression (Your Best)</h6>
                            <div class="progress mb-1">
                                <div class="progress-bar bg-success" style="width: 93.67%">ROC-AUC: 0.9367</div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <h6>LightGBM</h6>
                            <div class="progress mb-1">
                                <div class="progress-bar bg-warning" style="width: 68.11%">ROC-AUC: 0.6811</div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <h6>Watson AutoAI</h6>
                            <div class="progress mb-1">
                                <div class="progress-bar bg-info" style="width: 92%">ROC-AUC: 0.92</div>
                            </div>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <div class="text-center">
                        <small class="text-muted">
                            <i class="fas fa-info-circle"></i> 
                            Optimized for cold-start problem
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let selectedModelSource = null;
let selectedModel = null;

function selectModelSource(source) {
    selectedModelSource = source;
    
    // Update UI
    if (source === 'watson') {
        document.getElementById('watsonCard').classList.add('border-primary', 'border-3');
        document.getElementById('newCard').classList.remove('border-primary', 'border-3');
        document.getElementById('watsonModelSelection').style.display = 'block';
        document.getElementById('newModelTraining').style.display = 'none';
    } else {
        document.getElementById('newCard').classList.add('border-primary', 'border-3');
        document.getElementById('watsonCard').classList.remove('border-primary', 'border-3');
        document.getElementById('newModelTraining').style.display = 'block';
        document.getElementById('watsonModelSelection').style.display = 'none';
    }
}

function runTraining() {
    if (!selectedModelSource) {
        showNotification('Please select a model source first', 'warning');
        return;
    }
    
    if (selectedModelSource === 'watson') {
        selectedModel = document.getElementById('watsonModelSelect').value;
        if (!selectedModel) {
            showNotification('Please select a Watson X model', 'warning');
            return;
        }
    }
    
    // Show loading
    showNotification('Loading model...', 'info');
    
    // Send request
    $.ajax({
        url: '/train_model',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            model_source: selectedModelSource,
            selected_model: selectedModel
        }),
        success: function(response) {
            if (response.success) {
                // Show results
                document.getElementById('trainingResults').style.display = 'block';
                
                let statsHtml = '<div class="row">';
                statsHtml += '<div class="col-md-6">';
                statsHtml += '<h6>Model: ' + response.model_name + '</h6>';
                statsHtml += '</div>';
                statsHtml += '<div class="col-md-6">';
                statsHtml += '<h6>Accuracy: ' + (response.accuracy * 100).toFixed(2) + '%</h6>';
                statsHtml += '</div>';
                statsHtml += '</div>';
                
                if (response.stats) {
                    statsHtml += '<hr>';
                    statsHtml += '<div class="row">';
                    
                    if (response.stats.roc_auc) {
                        statsHtml += '<div class="col-md-3 text-center">';
                        statsHtml += '<h5 class="text-primary">' + response.stats.roc_auc + '</h5>';
                        statsHtml += '<small>ROC-AUC</small>';
                        statsHtml += '</div>';
                    }
                    
                    if (response.stats.precision) {
                        statsHtml += '<div class="col-md-3 text-center">';
                        statsHtml += '<h5 class="text-success">' + response.stats.precision + '</h5>';
                        statsHtml += '<small>Precision</small>';
                        statsHtml += '</div>';
                    }
                    
                    if (response.stats.recall) {
                        statsHtml += '<div class="col-md-3 text-center">';
                        statsHtml += '<h5 class="text-warning">' + response.stats.recall + '</h5>';
                        statsHtml += '<small>Recall</small>';
                        statsHtml += '</div>';
                    }
                    
                    if (response.stats.false_positives !== undefined) {
                        statsHtml += '<div class="col-md-3 text-center">';
                        statsHtml += '<h5 class="text-danger">' + response.stats.false_positives + '</h5>';
                        statsHtml += '<small>False Positives</small>';
                        statsHtml += '</div>';
                    }
                    
                    statsHtml += '</div>';
                }
                
                document.getElementById('modelStats').innerHTML = statsHtml;
                
                showNotification('Model loaded successfully!', 'success');
            } else {
                showNotification(response.message || 'Error loading model', 'error');
            }
        },
        error: function(xhr) {
            showNotification('Error connecting to server', 'error');
        }
    });
}

function proceedToPrediction() {
    window.location.href = '/prediction';
}

function viewModelDetails() {
    showNotification('Detailed model analysis coming soon!', 'info');
}

// Auto-select Watson if models are available
document.addEventListener('DOMContentLoaded', function() {
    "{% if watson_models %}"
    selectModelSource('watson');
    "{% endif %}"
});
</script>
{% endblock %}