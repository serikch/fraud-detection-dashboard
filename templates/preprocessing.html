{% extends "base.html" %}

{% block title %}Data Preprocessing - Fraud Detection System{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Preprocessing Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-watson alert-custom">
                <h4><i class="fas fa-cogs"></i> Data Preprocessing & Feature Engineering</h4>
                <p class="mb-0">Check files, verify columns, and prepare data for training</p>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- File Selection & Preprocessing -->
        <div class="col-lg-8 mb-4">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-wrench"></i> Preprocessing Pipeline</h5>
                </div>
                <div class="card-body">
                    <!-- File Selection -->
                    <div class="mb-4">
                        <h6><i class="fas fa-file-csv text-primary"></i> Select File to Process</h6>
                        
                        {% if watson_files %}
                        <div class="alert alert-success mt-3">
                            <i class="fas fa-check-circle"></i> <strong>Watson X preprocessed file detected!</strong>
                            <p class="mb-0">You can skip preprocessing and go directly to training.</p>
                        </div>
                        {% endif %}
                        
                        <div class="mt-3">
                            <label class="form-label">Choose uploaded file:</label>
                            <select class="form-select form-select-lg" id="fileSelect">
                                <option value="">-- Select a file --</option>
                                {% for file in uploaded_files %}
                                <option value="{{ file.filename }}" 
                                        data-type="{{ file.file_type }}"
                                        data-columns="{{ file.columns|length if file.columns else 0 }}">
                                    {{ file.original_name }} 
                                    (Type: {{ file.file_type }}, 
                                     Columns: {{ file.columns|length if file.columns else 'Unknown' }})
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <!-- File Information Display -->
                    <div id="fileInfo" class="mb-4" style="display: none;">
                        <h6><i class="fas fa-info-circle text-info"></i> File Information</h6>
                        <div class="bg-light p-3 rounded">
                            <div id="fileDetails"></div>
                        </div>
                    </div>

                    <!-- Missing Columns Alert -->
                    <div id="missingAlert" class="alert alert-warning" style="display: none;">
                        <h6><i class="fas fa-exclamation-triangle"></i> Missing Columns Detected</h6>
                        <div id="missingColumns"></div>
                        <hr>
                        <p class="mb-0">Please upload the missing files or use a preprocessed dataset.</p>
                    </div>

                    <!-- Success Alert -->
                    <div id="successAlert" class="alert alert-success" style="display: none;">
                        <h6><i class="fas fa-check-circle"></i> File Ready for Processing</h6>
                        <div id="successDetails"></div>
                    </div>

                    <!-- Run Preprocessing Button -->
                    <button class="btn btn-primary-custom btn-custom btn-lg w-100" id="preprocessBtn" onclick="runPreprocessing()">
                        <i class="fas fa-play"></i> Run Preprocessing
                    </button>

                    <!-- Processing Progress -->
                    <div id="processingProgress" style="display: none;" class="mt-4">
                        <h6><i class="fas fa-spinner fa-spin"></i> Processing...</h6>
                        <div class="progress progress-custom mb-2">
                            <div id="processProgressBar" class="progress-bar progress-bar-custom progress-bar-striped progress-bar-animated" style="width: 0%">0%</div>
                        </div>
                    </div>

                    <!-- Processing Results -->
                    <div id="processingResults" class="mt-4" style="display: none;">
                        <div class="alert alert-info">
                            <h6><i class="fas fa-check"></i> Processing Complete</h6>
                            <div id="resultsMessage"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card border-0 shadow-sm mt-4">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <button class="btn btn-success-custom btn-custom w-100" onclick="skipToTraining()">
                                <i class="fas fa-brain"></i> Skip to Training
                                <small class="d-block">(If using preprocessed file)</small>
                            </button>
                        </div>
                        <div class="col-md-6">
                            <button class="btn btn-outline-primary btn-custom w-100" onclick="uploadMore()">
                                <i class="fas fa-upload"></i> Upload More Files
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- File Status Panel -->
        <div class="col-lg-4 mb-4">
            <!-- Uploaded Files Summary -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-list"></i> Uploaded Files Status</h5>
                </div>
                <div class="card-body">
                    <div class="file-status-list">
                        {% for file in uploaded_files %}
                        <div class="mb-3 p-2 border-start border-3 
                                   {% if file.file_type == 'watson_preprocessed' %}border-success
                                   {% elif file.file_type == 'evaluation' %}border-warning
                                   {% elif file.file_type == 'transactions' %}border-primary
                                   {% else %}border-secondary{% endif %}">
                            <strong>{{ file.original_name }}</strong>
                            <br>
                            <small class="text-muted">
                                Type: <span class="badge bg-secondary">{{ file.file_type }}</span>
                                <br>
                                Columns: {{ file.columns|length if file.columns else 'Unknown' }}
                                {% if file.missing_columns %}
                                <br>
                                <span class="text-danger">Missing: {{ file.missing_columns|join(', ') }}</span>
                                {% endif %}
                            </small>
                        </div>
                        {% else %}
                        <p class="text-muted text-center">No files uploaded yet</p>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Required Files Checklist -->
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-warning">
                    <h5 class="mb-0 text-dark"><i class="fas fa-check-square"></i> Required Files</h5>
                </div>
                <div class="card-body">
                    <div class="checklist">
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="check1" 
                                   {% if transaction_files %}checked{% endif %} disabled>
                            <label class="form-check-label" for="check1">
                                transactions_train.csv
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="check2" disabled>
                            <label class="form-check-label" for="check2">
                                train_fraud_labels.json
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="check3" disabled>
                            <label class="form-check-label" for="check3">
                                cards_data.csv
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="check4" disabled>
                            <label class="form-check-label" for="check4">
                                users_data.csv
                            </label>
                        </div>
                        <hr>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="check5" 
                                   {% if watson_files %}checked{% endif %} disabled>
                            <label class="form-check-label" for="check5">
                                <strong>OR: Watson X Preprocessed File</strong>
                            </label>
                        </div>
                    </div>
                    
                    {% if watson_files %}
                    <div class="alert alert-success mt-3 mb-0">
                        <small><i class="fas fa-check"></i> Ready for training!</small>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// File selection handler
document.getElementById('fileSelect').addEventListener('change', function() {
    const selected = this.value;
    const selectedOption = this.options[this.selectedIndex];
    
    if (selected) {
        const fileType = selectedOption.dataset.type;
        const columns = selectedOption.dataset.columns;
        
        // Show file info
        document.getElementById('fileInfo').style.display = 'block';
        document.getElementById('fileDetails').innerHTML = `
            <strong>File:</strong> ${selected}<br>
            <strong>Type Detected:</strong> ${fileType}<br>
            <strong>Number of Columns:</strong> ${columns}<br>
            <strong>Status:</strong> ${getFileStatus(fileType)}
        `;
        
        // Show appropriate alert
        if (fileType === 'watson_preprocessed') {
            document.getElementById('successAlert').style.display = 'block';
            document.getElementById('missingAlert').style.display = 'none';
            document.getElementById('successDetails').innerHTML = 
                'This file is already preprocessed with Watson X features. You can proceed directly to training!';
        } else if (fileType === 'evaluation') {
            document.getElementById('successAlert').style.display = 'block';
            document.getElementById('missingAlert').style.display = 'none';
            document.getElementById('successDetails').innerHTML = 
                'Evaluation dataset detected. Ready for predictions (no labels needed).';
        } else if (fileType === 'transactions') {
            // Check if missing columns
            // This would need actual data from backend
            document.getElementById('missingAlert').style.display = 'block';
            document.getElementById('successAlert').style.display = 'none';
            document.getElementById('missingColumns').innerHTML = 
                'Need additional files for complete preprocessing: cards_data.csv, users_data.csv, train_fraud_labels.json';
        }
    } else {
        document.getElementById('fileInfo').style.display = 'none';
        document.getElementById('successAlert').style.display = 'none';
        document.getElementById('missingAlert').style.display = 'none';
    }
});

function getFileStatus(fileType) {
    const statusMap = {
        'watson_preprocessed': '<span class="badge bg-success">Ready</span>',
        'evaluation': '<span class="badge bg-warning">Evaluation Set</span>',
        'transactions': '<span class="badge bg-primary">Needs Joining</span>',
        'unknown': '<span class="badge bg-secondary">Unknown Format</span>'
    };
    return statusMap[fileType] || statusMap['unknown'];
}

function runPreprocessing() {
    const selectedFile = document.getElementById('fileSelect').value;
    
    if (!selectedFile) {
        showNotification('Please select a file to process', 'warning');
        return;
    }
    
    // Show progress
    document.getElementById('processingProgress').style.display = 'block';
    document.getElementById('processingResults').style.display = 'none';
    
    // Simulate progress
    let progress = 0;
    const interval = setInterval(() => {
        progress += 10;
        document.getElementById('processProgressBar').style.width = progress + '%';
        document.getElementById('processProgressBar').textContent = progress + '%';
        
        if (progress >= 100) {
            clearInterval(interval);
        }
    }, 200);
    
    // Send request
    $.ajax({
        url: '/preprocess',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            filename: selectedFile,
            use_watson: false
        }),
        success: function(response) {
            document.getElementById('processingProgress').style.display = 'none';
            document.getElementById('processingResults').style.display = 'block';
            
            let messageHtml = response.message;
            if (response.success) {
                messageHtml += '<br><br><a href="/training" class="btn btn-success btn-sm">Proceed to Training â†’</a>';
            }
            if (response.missing_columns && response.missing_columns.length > 0) {
                messageHtml += '<br><br><strong>Missing columns:</strong> ' + response.missing_columns.join(', ');
            }
            
            document.getElementById('resultsMessage').innerHTML = messageHtml;
            
            if (response.success) {
                showNotification('Preprocessing successful!', 'success');
            } else {
                showNotification(response.message, 'warning');
            }
        },
        error: function(xhr) {
            document.getElementById('processingProgress').style.display = 'none';
            showNotification('Error during preprocessing', 'error');
        }
    });
}

function skipToTraining() {
    // Check if we have a preprocessed file
    const fileSelect = document.getElementById('fileSelect');
    const selectedOption = fileSelect.options[fileSelect.selectedIndex];
    
    if (selectedOption && selectedOption.dataset.type === 'watson_preprocessed') {
        window.location.href = '/training';
    } else {
        showNotification('Please select a preprocessed Watson X file first', 'warning');
    }
}

function uploadMore() {
    window.location.href = '/upload';
}
</script>
{% endblock %}