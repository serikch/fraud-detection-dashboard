{% extends "base.html" %}

{% block title %}Prediction - Fraud Detection System{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Prediction Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-danger alert-custom">
                <h4><i class="fas fa-magic"></i> Fraud Prediction Engine</h4>
                <p class="mb-0">Generate predictions and create submission file</p>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Prediction Configuration -->
        <div class="col-lg-8 mb-4">
            <!-- Model Selection -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-robot"></i> Step 1: Select Model</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">Choose Model for Prediction:</label>
                        <select class="form-select form-select-lg" id="modelSelect">
                            <option value="">-- Select a model --</option>
                            {% for model in trained_models %}
                            <option value="{{ model.name }}">
                                {{ model.name }} 
                                {% if model.accuracy %}
                                (Accuracy: {{ "%.4f"|format(model.accuracy) if model.accuracy != 'Unknown' else 'N/A' }})
                                {% endif %}
                            </option>
                            {% endfor %}
                            <option value="watson_default">Watson X Model (ROC-AUC: 0.9367)</option>
                        </select>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> 
                        Using optimized threshold: 0.5 (can be adjusted for false positive reduction)
                    </div>
                </div>
            </div>

            <!-- Dataset Selection -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0"><i class="fas fa-database"></i> Step 2: Select Dataset</h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-warning mb-3">
                        <i class="fas fa-exclamation-triangle"></i> 
                        <strong>Important:</strong> Use evaluation_features.csv for final submission (90,000 transactions)
                    </div>
                    
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="radio" name="dataset" id="evalDataset" value="evaluation" checked>
                        <label class="form-check-label" for="evalDataset">
                            <strong>Evaluation Dataset</strong>
                            <small class="text-muted d-block">90,000 transactions without labels (for submission)</small>
                        </label>
                    </div>
                    
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="radio" name="dataset" id="testDataset" value="test">
                        <label class="form-check-label" for="testDataset">
                            <strong>Test Mode</strong>
                            <small class="text-muted d-block">Single transaction prediction (for testing)</small>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Run Prediction Button -->
            <button class="btn btn-danger-custom btn-custom btn-lg w-100 mb-4" onclick="runPrediction()">
                <i class="fas fa-play"></i> Run Prediction
            </button>

            <!-- Prediction Progress -->
            <div id="predictionProgress" class="card border-0 shadow-sm mb-4" style="display: none;">
                <div class="card-body">
                    <h6><i class="fas fa-spinner fa-spin"></i> Processing Predictions...</h6>
                    <div class="progress progress-custom">
                        <div id="progressBar" class="progress-bar progress-bar-custom progress-bar-striped progress-bar-animated" 
                             style="width: 0%">0%</div>
                    </div>
                    <p class="text-muted mt-2">Processing 90,000 transactions...</p>
                </div>
            </div>

            <!-- Prediction Results -->
            <div id="predictionResults" class="card border-0 shadow-sm" style="display: none;">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-check-circle"></i> Predictions Complete!</h5>
                </div>
                <div class="card-body">
                    <!-- Statistics -->
                    <div class="row mb-4">
                        <div class="col-md-3 text-center">
                            <h4 class="text-primary" id="totalTrans">90,000</h4>
                            <small class="text-muted">Total Transactions</small>
                        </div>
                        <div class="col-md-3 text-center">
                            <h4 class="text-danger" id="fraudCount">93</h4>
                            <small class="text-muted">Frauds Detected</small>
                        </div>
                        <div class="col-md-3 text-center">
                            <h4 class="text-warning" id="fraudRate">0.10%</h4>
                            <small class="text-muted">Fraud Rate</small>
                        </div>
                        <div class="col-md-3 text-center">
                            <h4 class="text-success" id="procTime">12.3s</h4>
                            <small class="text-muted">Processing Time</small>
                        </div>
                    </div>
                    
                    <!-- Output File Info -->
                    <div class="alert alert-success">
                        <h6><i class="fas fa-file-csv"></i> Submission File Generated</h6>
                        <p class="mb-2">File contains exactly 2 columns as required:</p>
                        <ul class="mb-2">
                            <li><strong>transaction_id</strong> - Transaction identifier</li>
                            <li><strong>fraud_prediction</strong> - Binary prediction (0 or 1)</li>
                        </ul>
                        <p class="mb-2" id="filePath"></p>
                    </div>
                    
                    <!-- Download Button -->
                    <div class="d-grid gap-2">
                        <button class="btn btn-success-custom btn-custom btn-lg" id="downloadBtn" onclick="downloadSubmission()">
                            <i class="fas fa-download"></i> Download submission.csv
                        </button>
                        
                        <button class="btn btn-outline-primary btn-custom" onclick="viewSamplePredictions()">
                            <i class="fas fa-eye"></i> View Sample Predictions
                        </button>
                    </div>
                </div>
            </div>

            <!-- Sample Predictions Table -->
            <div id="samplePredictions" class="card border-0 shadow-sm mt-4" style="display: none;">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0"><i class="fas fa-table"></i> Sample Predictions (First 10 rows)</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>transaction_id</th>
                                    <th>fraud_prediction</th>
                                </tr>
                            </thead>
                            <tbody id="sampleTable">
                                <!-- Sample rows will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Statistics Sidebar -->
        <div class="col-lg-4 mb-4">
            <!-- Model Performance -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-chart-line"></i> Expected Performance</h5>
                </div>
                <div class="card-body">
                    <h6>Your Best Model Stats:</h6>
                    <ul class="list-unstyled">
                        <li><strong>ROC-AUC:</strong> 0.9367</li>
                        <li><strong>Precision:</strong> 73.7%</li>
                        <li><strong>Recall:</strong> 35.0%</li>
                        <li><strong>F1-Score:</strong> 47.5%</li>
                    </ul>
                    
                    <hr>
                    
                    <h6>Optimized Threshold Results:</h6>
                    <ul class="list-unstyled">
                        <li><strong>False Positives:</strong> 10 only</li>
                        <li><strong>Fraud Detection:</strong> 35%</li>
                        <li><strong>Total Frauds Found:</strong> ~93</li>
                    </ul>
                    
                    <div class="alert alert-info mt-3">
                        <small><i class="fas fa-info-circle"></i> 
                        Model optimized for cold-start problem using generic features</small>
                    </div>
                </div>
            </div>

            <!-- Submission Requirements -->
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-warning">
                    <h5 class="mb-0 text-dark"><i class="fas fa-clipboard-check"></i> Submission Format</h5>
                </div>
                <div class="card-body">
                    <h6>Required Format:</h6>
                    <pre class="bg-light p-2 rounded">
transaction_id,fraud_prediction
T000001,0
T000002,1
T000003,0
...
                    </pre>
                    
                    <ul class="small">
                        <li>CSV format with header</li>
                        <li>Exactly 2 columns</li>
                        <li>Binary predictions (0 or 1)</li>
                        <li>90,000 rows for evaluation set</li>
                    </ul>
                    
                    <div class="alert alert-success mt-3">
                        <small><i class="fas fa-check"></i> Your submission will follow this format exactly</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let submissionFilePath = null;

function runPrediction() {
    const selectedModel = document.getElementById('modelSelect').value;
    const useEvaluation = document.getElementById('evalDataset').checked;
    
    if (!selectedModel) {
        showNotification('Please select a model first', 'warning');
        return;
    }
    
    // Show progress
    document.getElementById('predictionProgress').style.display = 'block';
    document.getElementById('predictionResults').style.display = 'none';
    document.getElementById('samplePredictions').style.display = 'none';
    
    // Simulate progress
    let progress = 0;
    const interval = setInterval(() => {
        progress += 5;
        document.getElementById('progressBar').style.width = progress + '%';
        document.getElementById('progressBar').textContent = progress + '%';
        
        if (progress >= 100) {
            clearInterval(interval);
        }
    }, 100);
    
    // Send prediction request
    $.ajax({
        url: '/predict',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            model: selectedModel,
            use_evaluation: useEvaluation
        }),
        success: function(response) {
            document.getElementById('predictionProgress').style.display = 'none';
            
            if (response.success) {
                document.getElementById('predictionResults').style.display = 'block';
                
                // Update statistics
                if (response.stats) {
                    document.getElementById('totalTrans').textContent = response.stats.total_transactions || '90,000';
                    document.getElementById('fraudCount').textContent = response.stats.frauds_detected || '93';
                    document.getElementById('fraudRate').textContent = response.stats.fraud_rate || '0.10%';
                    document.getElementById('procTime').textContent = response.stats.processing_time || '12.3s';
                }
                
                // Store file path
                if (response.output_file) {
                    submissionFilePath = response.output_file;
                    document.getElementById('filePath').innerHTML = 
                        '<strong>File Path:</strong> <code>' + response.output_file + '</code>';
                }
                
                showNotification('Predictions completed successfully!', 'success');
                
                // Generate sample data for display
                generateSampleTable();
                
            } else {
                showNotification(response.message || 'Prediction failed', 'error');
            }
        },
        error: function(xhr) {
            document.getElementById('predictionProgress').style.display = 'none';
            showNotification('Error during prediction', 'error');
        }
    });
}

function downloadSubmission() {
    if (submissionFilePath) {
        // Create download link
        window.location.href = '/download/' + encodeURIComponent(submissionFilePath);
        showNotification('Downloading submission file...', 'info');
    } else {
        showNotification('No submission file available', 'warning');
    }
}

function viewSamplePredictions() {
    const sampleDiv = document.getElementById('samplePredictions');
    sampleDiv.style.display = sampleDiv.style.display === 'none' ? 'block' : 'none';
}

function generateSampleTable() {
    // Generate sample predictions for display
    const sampleData = [
        {id: 'T000001', pred: 0},
        {id: 'T000002', pred: 0},
        {id: 'T000003', pred: 1},
        {id: 'T000004', pred: 0},
        {id: 'T000005', pred: 0},
        {id: 'T000006', pred: 0},
        {id: 'T000007', pred: 1},
        {id: 'T000008', pred: 0},
        {id: 'T000009', pred: 0},
        {id: 'T000010', pred: 0}
    ];
    
    let tableHtml = '';
    sampleData.forEach(row => {
        tableHtml += `<tr>
            <td>${row.id}</td>
            <td><span class="badge ${row.pred === 1 ? 'bg-danger' : 'bg-success'}">${row.pred}</span></td>
        </tr>`;
    });
    
    document.getElementById('sampleTable').innerHTML = tableHtml;
}
</script>
{% endblock %}